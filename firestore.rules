rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Students Collection
    match /students/{studentId} {
      // Parents can read their own students
      allow read: if request.auth != null &&
                  request.auth.uid == resource.data.parent_id;

      // Parents can create students
      allow create: if request.auth != null &&
                    request.auth.uid == request.resource.data.parent_id;

      // Parents can update their students
      allow update: if request.auth != null &&
                    request.auth.uid == resource.data.parent_id;

      // Parents can delete their students
      allow delete: if request.auth != null &&
                    request.auth.uid == resource.data.parent_id;
    }

    // Assessments Collection
    match /assessments/{assessmentId} {
      // Read if you own the student
      allow read: if request.auth != null &&
                  exists(/databases/$(database)/documents/students/$(resource.data.student_id)) &&
                  get(/databases/$(database)/documents/students/$(resource.data.student_id)).data.parent_id == request.auth.uid;

      // Create: Allow if parent_id matches auth UID (regardless of student existence - student might be in mock mode)
      allow create: if request.auth != null &&
                    request.resource.data.parent_id == request.auth.uid;

      // Update: Allow if you own the student (parent_id match) or if updating with analysis fields
      allow update: if request.auth != null &&
                    (request.resource.data.parent_id == request.auth.uid ||
                     // Also allow updates that include analysis results
                     request.resource.data.analysis_results != null);

      // Allow admin writes (for backend server operations)
      allow update: if request.auth == null && request.auth.token.admin == true;

      // Delete: Allow if you own the student
      allow delete: if request.auth != null &&
                    resource.data.parent_id == request.auth.uid;
    }

    // Analysis Results Collection
    match /analysis/{analysisId} {
      // Read if you own the student
      allow read: if request.auth != null &&
                  exists(/databases/$(database)/documents/students/$(resource.data.student_id)) &&
                  get(/databases/$(database)/documents/students/$(resource.data.student_id)).data.parent_id == request.auth.uid;

      // Allow Cloud Functions to write (they run with admin privileges)
      // Parents cannot write to analysis
      allow write: if false;
    }

    // Support Requests Collection
    match /support_requests/{requestId} {
      // Allow anyone to create support requests
      allow create: if true;
      // Only allow reads/updates for admin operations
      allow read, update: if request.auth == null && request.auth.token.admin == true;
    }

    // Consultations Collection
    match /consultations/{consultationId} {
      // Allow authenticated users to create consultations
      allow create: if request.auth != null;
      // Allow admin reads/updates
      allow read, update: if request.auth == null && request.auth.token.admin == true;
    }

    // Allow parents collection to be readable/writable by authenticated users
    match /parents/{parentId} {
      allow read, write: if request.auth != null && request.auth.uid == parentId;
    }
  }
}
