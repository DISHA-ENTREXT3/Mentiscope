rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Students Collection
    match /students/{studentId} {
      // Parents can read their own students (including password field for now)
      allow read: if request.auth != null && 
                  request.auth.uid == resource.data.parent_id;
      
      // Parents can create students
      allow create: if request.auth != null && 
                    request.auth.uid == request.resource.data.parent_id &&
                    // Ensure password is provided (10 characters)
                    request.resource.data.password is string &&
                    request.resource.data.password.size() == 10 &&
                    // Ensure neural_id is provided
                    request.resource.data.neural_id is string;
      
      // Parents can update their students (but not password or neural_id)
      allow update: if request.auth != null && 
                    request.auth.uid == resource.data.parent_id &&
                    // Prevent password modification via update
                    request.resource.data.password == resource.data.password &&
                    // Prevent neural_id modification
                    request.resource.data.neural_id == resource.data.neural_id;
      
      // Parents can delete their students
      allow delete: if request.auth != null && 
                    request.auth.uid == resource.data.parent_id;
    }
    
    // Assessments Collection
    match /assessments/{assessmentId} {
      // Read if you own the student
      allow read: if request.auth != null && 
                  exists(/databases/$(database)/documents/students/$(resource.data.student_id)) &&
                  get(/databases/$(database)/documents/students/$(resource.data.student_id)).data.parent_id == request.auth.uid;
      
      // Create: Allow if user claims ownership (sets parent_id to self) and student exists
      allow create: if request.auth != null && 
                    request.resource.data.parent_id == request.auth.uid &&
                    exists(/databases/$(database)/documents/students/$(request.resource.data.student_id));
      
      // Update: Allow if you own the student OR if it's the backend service updating analysis
      allow update: if request.auth != null && (
                    (exists(/databases/$(database)/documents/students/$(resource.data.student_id)) &&
                     get(/databases/$(database)/documents/students/$(resource.data.student_id)).data.parent_id == request.auth.uid) ||
                    // Allow service account to update analysis_results, status, and analyzed_at
                    (request.resource.data.analysis_results != null &&
                     request.resource.data.status != null &&
                     request.resource.data.analyzed_at != null)
                   );
    }
    
    // Analysis Results Collection
    match /analysis/{analysisId} {
      // Read if you own the student
      allow read: if request.auth != null && 
                  exists(/databases/$(database)/documents/students/$(resource.data.student_id)) &&
                  get(/databases/$(database)/documents/students/$(resource.data.student_id)).data.parent_id == request.auth.uid;
      
      // Allow Cloud Functions to write (they run with admin privileges)
      // Parents cannot write to analysis
      allow write: if false;
    }
    
    // Allow parents collection to be readable/writable by authenticated users
    match /parents/{parentId} {
      allow read, write: if request.auth != null && request.auth.uid == parentId;
    }
  }
}
